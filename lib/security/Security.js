/*! letrest - v0.2.0 - 2016-04-20 */var CONFIG=require("../Config.js").getSecurity().config,DB=require("uw").DB,LOG=require("uw").log,Q=require("q"),UTIL=require("util"),MOMENT=require("moment"),JWT=require("jwt-simple"),PR=require("../protocol/Protocol.js"),STRATEGY=require(CONFIG.STRATEGY.IMPORT),VALIDATOR=require("jsonschema").Validator,SCHEMA=require("./credentialschema.json"),MODULE="SECURITY	",createPayload=function(a,b,c,d,e){var f=MOMENT().add(CONFIG.KEYEXPIRATION,"hours").valueOf(),g={sso:a,ttl:f,role:b,name:c,nick:d,exceptions:e};return g},createSessionToken=function(a,b,c,d,e){return JWT.encode(createPayload(a,b,c,d,e),CONFIG.KEYPASS)},recoverSessionToken=function(a){return JWT.decode(a,CONFIG.KEYPASS)},validateSessionToken=function(a){var b=recoverSessionToken(a),c=MOMENT()-b.ttl;if(c>0)throw new Error("Session expired");return b};exports.secure=function(a,b){return function(c,d,e){function f(a,b){var d=a==c.letrest.session.role.name,e=!b&&a<=c.letrest.session.role.weight,f=b&&a==c.letrest.session.role.weight;return d||e||f}var g=b.weight||a.weight,h=b.weightStrict||a.weightStrict||!1,i=g;if(Array.isArray(g)||(i=[g]),LOG.info(MODULE,"Validating weight for "+a.name+" with weight "+g),c.letrest&&c.letrest.session&&c.letrest.session.role){if("undefined"!=typeof c.letrest.session.exceptions[b.name])k=c.letrest.session.exceptions[b.name];else for(var j=0,k=!1;j<i.length&&!k;j++)k=f(i[j],h);k?e():(LOG.warn(MODULE,"Not enough rights for request"),d.send(403))}else-1!==g?(LOG.warn(MODULE,"User must be logged to use the service"),d.send(401)):e()}},exports.config=function(a){a.use(function(a,b,c){var d=!1;if(a.headers.origin&&(b.header("Access-Control-Allow-Origin",a.headers.origin),d=!0),a.headers["access-control-request-method"]&&(b.header("Access-Control-Allow-Methods",a.headers["access-control-request-method"]),d=!0),a.headers["access-control-request-headers"]&&(b.header("Access-Control-Allow-Headers",a.headers["access-control-request-headers"]),d=!0),d&&b.header("Access-Control-Max-Age",31536e3),d&&"OPTIONS"==a.method)b.status(200).end();else{var e;try{var f=a.header("Token");if(LOG.info(MODULE,"Populating session for token =>",f),f&&(e=validateSessionToken(f)),!e)throw new Error}catch(g){LOG.error(MODULE,"Failed to parse token",f,g.toString()),e=void 0}a.letrest={session:e},c()}}),a.use(CONFIG.SECURED_PATH.path,function(a,b,c){LOG.info("Authorized request");try{var d=a.header("Token");if(!d)throw new Error("Unauthorized request");var e=validateSessionToken(d),f=new RegExp("^[/]"+e.sso+"$|^[/]"+e.sso+"[/]");if(!f.test(a.url))throw new Error("Unauthorized path request");c()}catch(g){LOG.error(g),b.status(401).send(PR.newError(401,"You need to have a valid session"))}}),a.post(CONFIG.REGISTER_PATH.path,function(a,b){console.log("should not  have a session")});var b=function(a){LOG.info(MODULE,"Mixining in session with roles");var b=Q.defer();return STRATEGY.getRoles().then(function(c){for(var d={},e=0;e<c.length;e++)d[c[e][CONFIG.CREDENTIAL_ROLE]]=c[e][CONFIG.CREDENTIAL_WEIGHT];b.resolve({roles:d,session:a})}),b.promise},c=function(a){LOG.info(MODULE,"Mixining in session with roles");var b=Q.defer();return STRATEGY.getServiceExceptions().then(function(c){var d={};for(e in c){var f=c[e];d[f.accountid]||(d[f.accountid]={}),d[f.accountid][f.service]=f.permission}a.exceptions=d,a.session.exceptions=d[a.session.sso],b.resolve(a)}),b.promise};a.get(CONFIG.ROLE_PATH.path,function(a,c){var d;try{var e=a.header("Token");e&&(d=validateSessionToken(e)),delete d.ttl}catch(f){d=void 0}b(d).then(function(a){c.send(PR.success("session","get",a))})["catch"](function(a){c.send(PR.newError(2,"Failed to retrieve roles",a))})}),a.post(CONFIG.LOGIN_PATH.path,function(a,d){try{var e=a.body,f=(new VALIDATOR).validate(e,SCHEMA);f.errors.length>0?d.status(400).send(f.errors):STRATEGY.login(a.body).then(function(a){if(null==a)d.send(PR.newError(0,"Username or password incorrect",""));else{var e={name:"GUEST",weight:-1};a[CONFIG.CREDENTIAL_ROLE]&&(e.name=a[CONFIG.CREDENTIAL_ROLE],e.weight=a[CONFIG.CREDENTIAL_WEIGHT],e.id=a[CONFIG.CREDENTIAL_ROLE_ID]);var f={},g=a[CONFIG.CREDENTIAL_NAME]||"Guest",h=createPayload(a[CONFIG.CREDENTIAL_KEY],e,g,a[CONFIG.CREDENTIAL_NICK],f);delete h.ttl,b(h).then(c).then(function(b){d.send({msg:"Login successful",token:createSessionToken(a[CONFIG.CREDENTIAL_KEY],e,g,a[CONFIG.CREDENTIAL_NICK],b.session.exceptions),session:b})})["catch"](function(a){LOG.error(MODULE,a),d.send(PR.newError(1,"Internal problem error",a))})}})["catch"](function(a){LOG.error(MODULE,a),d.send(PR.newError(2,"Internal problem error",a))})}catch(g){d.send(PR.newError(2,"Bad format message",g))}})};