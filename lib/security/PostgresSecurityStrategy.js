/*! letrest - v0.3.5 - 2016-09-20 */var CONFIG=require("../Config.js").getSecurity().config.STRATEGY,Q=require("q"),UTIL=require("util"),DBManager=require("../database/DBManager.js"),CONST_LOGIN_QUERY=UTIL.format("select * from %s where %s='%%s' and %s='%%s'",CONFIG.TABLE,CONFIG.FIELDS.NICK,CONFIG.FIELDS.PASSWORD),MODULE="PGSQL-SECURITY\t",LOG=require("uw-log").newInstance(MODULE);exports.register=function(){},exports.getRoles=function(){LOG.info("Retriving available roles");var a=DBManager.newInstance().init(CONFIG);return CONFIG.ROLE_JSON?(LOG.info("Using JSON provided instead query"),CONFIG.ROLE_JSON):a.connection.open().then(a.connection.query.bind(null,CONFIG.ROLE_SQL)).then(function(a){return a.getLastResult().rows}).catch(function(a){throw LOG.error("Failed to executed credentials query."),a}).finally(a.finish)},exports.getServiceExceptions=function(a){LOG.info("Retriving available exceptions");var b=DBManager.newInstance().init(CONFIG),c=CONFIG.SERVICE_EXCEPTION_SQL;return a&&(c+=CONFIG.EXCEPTION_BY_ACCOUNT_SQL,c=c.replace("?",a)),b.connection.open().then(b.connection.query.bind(null,c)).then(function(a){return a.getLastResult().rows}).catch(function(a){throw LOG.error("Failed to executed exceptions query."),a}).finally(b.finish)},exports.login=function(a){LOG.info("Procesing login request for user:",a.username);var b=DBManager.newInstance().init(CONFIG),c=UTIL.format(CONFIG.LOGIN_SQL||CONST_LOGIN_QUERY,a.username,a.password);try{return b.connection.open().then(b.connection.query.bind(null,c)).then(function(a){return 0==a.getLastResult().rows.length?null:a.getLastResult().rows[0]}).catch(function(a){throw LOG.error("Failed to executed credentials query."),a}).finally(b.finish)}catch(a){throw LOG.error("Error executing login."),a}},exports.logout=function(){};