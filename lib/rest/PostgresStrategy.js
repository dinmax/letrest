/*! letrest - v1.0.0 - 2016-04-05 */var CONFIG=require("../Config.js").getConfig(),DB=require("uw").DB,UW_U=require("uw").util,LOG=require("uw").log,Q=require("q"),UTIL=require("util"),DOTTY=require("dotty"),MODULE="PGSQL  	",M=require("moment"),QUERY=function(a,b,c,d,e,f,g){var h="SELECT %s FROM %s %s WHERE %s %s %s %s",i="INSERT INTO %s (%s) VALUES(%s) RETURNING %s",j="UPDATE %s SET %s WHERE %s  RETURNING %s",l="DELETE FROM %s WHERE %s",m=!1,n=0,o={},p=function(a,b){var b=b.toLowerCase();switch(b){case"boolean":return new Boolean(a);case"number":return new Number(a);case"date":var c=new Date(a);return c.setUTCMilliseconds(0),c.setUTCSeconds(0),c.setUTCMinutes(0),c.setUTCHours(0),c.toUTCString();default:return a}};this.enrichRows=function(a){for(var b=[],d=0;d<a.length;d++)b.push(this.enrichRow(a[d],c));return b.from=n,b.paginated=m,b.total_rows=a.length<=0?0:a[0].__rowstotal,b},this.enrichRow=function(a){var b={};if(!a)return b;for(k in o){var c=o[k];DOTTY.put(b,c.attribute.replace(new RegExp("_f_","g"),"."),p(a[c.attribute],c.type))}return b};var q=function(){var a="";if(c.service&&c.service.post){if(c.fk)for(var b in c.fk)a+=","+c.fk[b].field;var d=c.mapping;if(!d)throw new Error("You MUST specify a mapping for the entity '"+c.table+"'");for(var e=0;e<d.length;e++){var f=d[e];f.external||(a+=","+f.field.split("@")[0])}}return a.substring(1,a.length)},r=function(a){var b;if("url"==a.type||"path"==a.type?(console.log("getFKValue - URL or PATH",a.value),b=d[a.value]):(console.log("getFKValue - DOTTY",a.value),b=DOTTY.get(e,a.value)),a.sql){var c=a.sql;return c=x(c),b||(b=null),c=c.replace(new RegExp("#value#","g"),b),console.log("getFKValue - sql",c),c}return b},s=function(){var a="";if(c.service&&c.service.post){if(c.fk)for(var b in c.fk)a+=","+r(c.fk[b]);for(var d=c.mapping,e=0;e<d.length;e++){var f=d[e];f.external||(a+=","+t(f.attribute.replace(new RegExp("@","g"),"."),f.type,f.value))}}return a.substring(1,a.length)},t=function(a,b,c){switch(console.log("getMappingValue",a,b,c),b||"object"){default:var d=DOTTY.get(e,a);return void 0==d?"null":"json"==b?"'"+JSON.stringify(d)+"'":"'"+new String(d).replace(new RegExp("'","g"),"''")+"'";case"value":return c}},u=function(a){var b=a.split("@");return b.length<2?b[0]:b[1]+"."+b[0]},v=function(a,b){var c=b.type,d=b.prefix||"",e=b.suffix||"";if(null==a||void 0==a)return null;try{switch((c||"string").toLocaleLowerCase()){case"sql":return a;case"date":var f=require("moment");return a=a.replace('""','"'),a=f(a.substr(0,10),"YYYY/MM/DD").format("YYYY/MM/DD"),"'"+d+a+e+"'";case"datetime":var f=require("moment");return a=f(a).format("YYYY/MM/DD HH:mm:ss"),"'"+d+a+e+"'";case"number":if(isNaN(a))throw new Error("Not a valid number:"+a);return a;case"boolean":return new Boolean(a);default:return"'"+d+a+e+"'"}}catch(g){throw LOG.error(MODULE,"Failed to parse filter type:"+c,error),g}},w=function(a){var b="",c=function(b){switch(b.source){case"path":return b.field+" "+b.comparator+" "+x(d[a.key]||b.value);case"url":return b.field+" "+b.comparator+" "+x(v(f[a.key],b)||b.value);case"security":return b.field+" "+b.comparator+" "+x(b.value)}};if(a.field instanceof Array){b+="( false ";for(var e=0;e<a.field.length;e++){var g=JSON.parse(JSON.stringify(a));g.field=a.field[e],g.value=a.value[e],b+=" OR "+c(g)}b+=")"}else if(f[a.key]&&0==f[a.key].indexOf("@[")){var h=/^@\[(.*)[\]]$/,i="$1",j=f[a.key].replace(h,i),k=j.split(",");b+="( false ";for(var e=0;e<k.length;e++)f[a.key]=k[e],b+=" OR "+c(a);b+=")"}else b=c(a);return b},x=function(a){try{a=UW_U.replaceAll(a,"#account_id#",g.sso),a=UW_U.replaceAll(a,"#account_nick#",g.nick),a=UW_U.replaceAll(a,"#account_role_id#",g.role.id),a=UW_U.replaceAll(a,"#account_role#",g.role.name),a=UW_U.replaceAll(a,"#account_weight#",g.role.weight)}catch(b){console.log(MODULE,"processSecurity security undefined!")}return a},y=function(){var b="1=1";if(c.service&&c.service[a]&&c.service[a].filter){var e=c.service[a].filter;for(var f in e)e[f].mode&&"dummy"==e[f].mode||(b+=" and "+w(e[f]))}return d[CONFIG.pk_name]&&(b+=" and "+c.table+"."+u(c.pk)+"="+d[CONFIG.pk_name]),b},z=function(){var a="";if(c.service&&c.service.put){if(c.fk)for(var b in c.fk)c.fk[b].field!=c.pk&&(a+=","+c.fk[b].field+"="+r(c.fk[b]));for(var d=c.mapping,e=0;e<d.length;e++){var f=d[e];f.external||(a+=","+f.field.split("@")[0]+"="+t(f.attribute.replace(new RegExp("@","g"),"."),f.type,f.value))}a=a.substring(1,a.length)}if(!a)throw new Error("processSets, unable to find a valid service.");return a},A=function(){if("all"==a&&f.GROUP)return f.ORDER?G():c.service[a].group.order?F().replace("GROUP BY","ORDER BY"):E().replace("GROUP BY","ORDER BY");if("all"==a&&f.ORDER){for(var b=f.ORDER.split(","),d="",e=0;e<b.length;e++){var g=b[e].trim().split(" ");if(g.length>2)throw new Error("Bad Order format. It should be 'order [asc|desc],order1 [asc|desc]. Spaces are not allowed between order and modificator");if(c.service[a].order){var h=c.service[a].order[g[0]];if(!h)throw new Error("Order '"+g[0]+"' not defined on the entity.");d+=","+h+(g.length>1?" "+g[1]:"")}else d+=","+g[0]+" "+g[1]}return d&&(d=" ORDER BY "+d.substring(1)),d}return c.service[a].order&&c.service[a].order["default"]?" ORDER BY "+c.service[a].order["default"]:""},B=function(){if("all"==a&&f.FROM&&f.ROWS){var b=/[0-9]*/;if(!(f.FROM&&f.ROWS&&b.test(f.FROM)&&b.test(f.ROWS)))throw new Error("Not a valid pagination form. Valid: url?FROM(numeric)=1&ROWS(numeric)=5. Rows should be larger than 1.");return n=f.FROM,m=!0," OFFSET "+f.FROM+" LIMIT "+Math.min(CONFIG.max_rows,f.ROWS)}return" OFFSET 0 "+(c.nolimit?"":"LIMIT "+CONFIG.max_rows)},C=function(){var a="";if(c.fk)for(var b in c.fk){var d=c.fk[b],e=d.relation.split("@"),f=d.jointype||"INNER",g=d.source||c.table,h=d.comparator||"=",i=d.alias?" as "+d.alias:"",j=d.alias?d.alias:e[1];a+=" "+f+" JOIN "+e[1]+i+" ON "+j+"."+e[0]+h+g+"."+d.field+" "}return a},D=function(){var a,b=",";if(f.GROUP){a=[];var d=c.service.all.group,e=d.measures,g=d.dimensions,h=null;if("*"!=f.GROUP.trim()){var i=f.GROUP.split(",");h={};for(var j=0;j<i.length;j++)h[i[j]]="OK"}else h=g;Object.keys(e).forEach(function(b){a.push(e[b])}),Object.keys(g).forEach(function(b){h[b]&&a.push(g[b])})}else a=c.mapping;for(var j=0;j<a.length;j++){var k=a[j].attribute.replace(new RegExp("@","g"),"_f_"),l=a[j].field.replace(new RegExp("@","g"),"_f_");o[l]={attribute:k,type:a[j].type||"string"},b+=u(a[j].field)+" as "+k+","}return b.substring(1,b.length-1)},E=function(){if(f.GROUP){var a="",b=null;if("*"!=f.GROUP)for(var b={},d=f.GROUP.split(","),e=0;e<d.length;e++)b[d[e]]="OK";var g=c.service.all.group,h=g.dimensions;return Object.keys(h).forEach(function(c){(null==b||b[c])&&(a+=","+h[c].field.replace(new RegExp("@","g"),"."))})," GROUP BY "+a.substring(1,a.length)+" "}return""},F=function(){var a="",b="";if("*"!=f.GROUP){var d={};b=f.GROUP.split(",");for(var e=0;e<b.length;e++)d[b[e]]="OK"}if("*"!=f.AGGREGATE){var g={};b=f.AGGREGATE.split(",");for(var e=0;e<b.length;e++)g[b[e]]="OK"}var h=c.service.all.group,i=h.dimensions,j=h.measures;b=c.service.all.group.order;for(var e=0;e<b.length;e++)k=b[e].trim().split(" ")[0],direction=b[e].trim().split(" ")[1]?" "+b[e].trim().split(" ")[1]:"",i[k]&&(null==d||d[k])&&(a+=","+i[k].field.replace(new RegExp("@","g"),".")+direction),j[k]&&g[k]&&(a+=","+j[k].field.replace(new RegExp("@","g"),".")+direction);return"ORDER BY "+a.substring(1,a.length)+" "},G=function(){var a="",b=null;if("*"!=f.ORDER)for(var b={},d=f.ORDER.split(","),e=0;e<d.length;e++)b[d[e].trim().split(" ")[0]]={order:d[e].trim().split(" ")[1]};var g=c.service.all.group,h=g.dimensions;Object.keys(h).forEach(function(c){(null==b||b[c])&&(a+=","+h[c].field.replace(new RegExp("@","g"),".")+" "+b[c].order)});var i=g.measures;return Object.keys(i).forEach(function(c){(null==b||b[c])&&(a+=","+i[c].attribute.replace(new RegExp("@","g"),".")+" "+b[c].order)})," ORDER BY "+a.substring(1,a.length)+" "};this.parse=function(){if(!c.pk)throw new Error('You MUST specify a PK for the entity "'+c.name+"'");switch(b){case"select":var a=",count(1) over() as __ROWSTOTAL";return LOG.show(MODULE,UTIL.format(h,D()+a,c.table,C(),y(),E(),A(),B()));case"insert":return LOG.show(MODULE,UTIL.format(i,c.table,q(),s(),c.pk));case"update":return LOG.show(MODULE,UTIL.format(j,c.table,z(),y(),c.pk));case"delete":return LOG.show(MODULE,UTIL.format(l,c.table,y()))}}};exports.select=function(a){var b=Q.defer(),c=new QUERY(a.mode,"select",a.entity,a.params,null,a.query,a.letrest.session);return DB.query(c.parse()).then(function(d){a.arr=c.enrichRows(d.rows),b.resolve(a)})["catch"](function(a){LOG.error(a),b.reject("Failed to execute query")}),b.promise},exports.insert=function(a){LOG.verbose(MODULE,"Insert request");var b=Q.defer(),c=new QUERY(a.mode,"insert",a.entity,a.params,a.body,a.query,a.letrest.session);return DB.query(c.parse()).then(function(c){var d=a.body;d[a.entity.pk]=c.rows[0][a.entity.pk],a.arr=d,b.resolve(a)})["catch"](function(a){LOG.error(a),b.reject("Failed to execute query")}),b.promise},exports.update=function(a){var b=Q.defer(),c=new QUERY(a.mode,"update",a.entity,a.params,a.body,a.query,a.letrest.session);return DB.query(c.parse()).then(function(c){var d=a.body;d[a.entity.pk]=c.rows[0][a.entity.pk],a.arr=d,b.resolve(a)})["catch"](function(a){LOG.error(a),b.reject("Failed to execute query")}),b.promise},exports["delete"]=function(a){var b=Q.defer(),c=new QUERY(a.mode,"delete",a.entity,a.params,a.body,a.query,a.letrest.session);return DB.query(c.parse()).then(function(c){a.arr={rowsAffected:c.rowCount},b.resolve(a)})["catch"](function(a){LOG.error(a),b.reject("Failed to execute query")}),b.promise};