/*! letrest - v0.0.16 - 2015-03-03 */var CONFIG=require("../../../../letrest_entities.json").config,DB=require("uw").DB,LOG=require("uw").log,Q=require("q"),UTIL=require("util"),QUERY=function(a,b,c,d,e,f){var g="SELECT * FROM %s WHERE %s %s %s",h="INSERT INTO %s (%s) VALUES(%s) RETURNING %s",i="UPDATE %s SET %s WHERE %s  RETURNING %s",j="DELETE FROM %s WHERE %s",k=!1,l=0;this.enrichRows=function(a){for(var b=[],d=0;d<a.length;d++)b.push(this.enrichRow(a[d],c));return b.from=l,b.paginated=k,b},this.enrichRow=function(a){if(!a)return{};var b=a.data;return b.entity=c.table,b[c.pk]=a[c.pk],b};var m=function(){var a="";if(c.service&&c.service.post.filter)for(var b in c.service.post.filter)a=a+b+",";return a+"data"},n=function(){var a="";if(c.service&&c.service.post.filter)for(var b in c.service.post.filter)a=a+d[b]+",";return a+"'"+JSON.stringify(e)+"'"},o=function(){var b="1=1";if(c.service&&c.service[a]&&c.service[a].filter)for(var e in c.service[a].filter)b+=" and "+e+"="+d[e];return d[CONFIG.pk_name]&&(b+=" and "+c.pk+"="+d[CONFIG.pk_name]),b},p=function(){return"data='"+JSON.stringify(e)+"'"},q=function(){if("all"==a&&f.ORDER){for(var b=f.ORDER.split(","),d="",e=0;e<b.length;e++){var g=b[e].trim().split(" ");if(g.length>2)throw new Error("Bad Order format. It should be 'order [asc|desc],order1 [asc|desc]. Spaces are not allowed between order and modificator");if(c.service[a].order){var h=c.service[a].order[g[0]];if(!h)throw new Error("Order '"+g[0]+"' not defined on the entity.");d+=","+h+(g.length>1?" "+g[1]:"")}}return d&&(d=" ORDER BY "+d.substring(1)),d}return""},r=function(){if("all"==a&&f.FROM&&f.ROWS){var b=/[0-9]*/;if(!(f.FROM&&f.ROWS&&b.test(f.FROM)&&b.test(f.ROWS)))throw new Error("Not a valid pagination form. Valid: url?FROM(numeric)=1&ROWS(numeric)=5. Rows should be larger than 1.");return l=f.FROM,k=!0," OFFSET "+f.FROM+" LIMIT "+Math.min(CONFIG.max_rows,f.ROWS)}return" OFFSET 0 LIMIT "+CONFIG.max_rows};this.parse=function(){switch(b){case"select":return UTIL.format(g,c.table,o(),q(),r());case"insert":return UTIL.format(h,c.table,m(),n(),c.pk);case"update":return UTIL.format(i,c.table,p(),o(),c.pk);case"delete":return UTIL.format(j,c.table,o())}}};exports.select=function(a,b,c,d,e){var f=Q.defer(),e=new QUERY(c,"select",a,b,null,e);return DB.query(e.parse()).then(function(a){f.resolve(e.enrichRows(a.rows))})["catch"](function(a){LOG.error(a),f.reject("Failed to execute query")}),f.promise},exports.insert=function(a,b,c,d,e,f){var g=Q.defer(),e=new QUERY(c,"insert",a,b,d,e,f);return DB.query(e.parse()).then(function(a){var b=a.rows[0];b.data=d,g.resolve(e.enrichRow(b))})["catch"](function(a){LOG.error(a),g.reject("Failed to execute query")}),g.promise},exports.update=function(a,b,c,d){var e=Q.defer(),f=new QUERY(c,"update",a,b,d);return DB.query(f.parse()).then(function(a){var b=a.rows[0];b.data=d,e.resolve(f.enrichRow(b))})["catch"](function(a){LOG.error(a),e.reject("Failed to execute query")}),e.promise},exports["delete"]=function(a,b,c,d){var e=Q.defer(),f=new QUERY(c,"delete",a,b,d);return DB.query(f.parse()).then(function(a){0==a.rowCount?e.reject(null):e.resolve(null)})["catch"](function(a){LOG.error(a),e.reject("Failed to execute query")}),e.promise};