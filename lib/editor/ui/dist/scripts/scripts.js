/*! letrest - v0.3.6 - 2016-10-19 */"use strict";angular.module("LetRestEditor",["ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.router","ui.bootstrap","dialogs.main"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/entity"),a.state("entities",{url:"/entity",templateUrl:"../views/entities/main.html",controller:"EntitiesCtrl as Entities"}).state("services",{url:"/service",templateUrl:"../views/service/main.html",controller:"ServiceCtrl as Services"}).state("services.edit",{url:"/:service",templateUrl:"../views/service/edit.html"}).state("entities.edit",{url:"/:entity",templateUrl:"../views/entities/entity.html"}).state("config",{url:"/config",templateUrl:"../views/config/config.html",controller:"ConfigCtrl as Config"}).state("wizard",{url:"/wizard",templateUrl:"../views/wizard/wizard.html",controller:"EntityWizardCtrl as EntityWizard"})}]).constant("K",{ENTITIES_URL:"http://localhost:8001/api/entities/",TABLES_URL:"http://localhost:8001/api/tables/",ACTIONS_URL:"http://localhost:8001/api/actions/",CONFIG_UW_URL:"http://localhost:8001/api/config/uw/",CONFIG_GENERAL_URL:"http://localhost:8001/api/config/general/",CONFIG_SECURITY_URL:"http://localhost:8001/api/config/security/",SERVICES_URL:"http://localhost:8001/api/services/"}),angular.module("LetRestEditor").directive("customValidation",["$parse",function(a){return{require:"ngModel",link:function(b,c,d,e){var f=d.customValidation;f instanceof Object==0&&(f={name:"customValidation",callback:f});var g=f;g instanceof Array==0&&(g=[f]),angular.forEach(g,function(c,d){e.$validators[c.name]=function(d,f){if(e.$isEmpty(d))return!0;var g=a(c.callback);return g(b)(f)}},this)}}}]),angular.module("LetRestEditor").factory("GeneralService",function(){var a={};return a.alerts=[],a.addAlert=function(b,c){a.alerts.length>=2&&a.alerts.splice(0,1),a.alerts.push({type:b,msg:c})},a}),angular.module("LetRestEditor").controller("GeneralCtrl",["$scope","GeneralService",function(a,b){this.alerts=b.alerts,this.closeAlert=function(a){b.alerts.splice(a,1)}}]),angular.module("LetRestEditor").controller("DimensionCtrl",["$scope","dialogs","ParserService",function(a,b,c){this.selection=null;var d=a.Entities,e=d.selection.table,f=["key","keyOriginal"];this.dimensions=d.selection.service.all.group.dimensions,this.isKeyValid=function(a){return void 0===this.dimensions[a]},this.select=function(a,b){this.tables=d.getSelectionTables(),this.selection=angular.copy(a),this.selection.key=b,this.selection.keyOriginal=this.selection.key,this.selection.field=c.parseTableRef(this.selection.field,e),this.selection.attribute=this.selection.attribute||this.selection.key},this.remove=function(a){var c=function(b){delete this.dimensions[a],d.save()}.bind(this),e=b.confirm("Please Confirm","Are you sure you want to remove the <strong>"+a+"</strong> dimension? This operation can´t be undone");e.result.then(c)},this.add=function(a){this.select({attribute:a},a)},this.save=function(){this.selection.field=this.selection.field.table+"."+this.selection.field.field,this.dimensions[this.selection.key]=this.selection,angular.forEach(this.selection,function(a,b){f.indexOf(b)>=0&&delete this.selection[b]},this),console.log(this.selection),d.save(),this.cancel()},this.cancel=function(){this.selection=null}}]),angular.module("LetRestEditor").controller("EntitiesCtrl",["$scope","$state","EntitiesService","DatabaseService","GeneralService","dialogs",function(a,b,c,d,e,f){var g=this;g.selection={service:{}},g.serviceHelper=null,g.active=null,g.working=!1,g.entities=c.list,g.tables=d.all,g.error=!1,g.tabsSelected="general",g.selectTab=function(a){g.tabSelected=a},g.isTabSelected=function(a){if(a instanceof Array)for(var b=0;b<a.length;b++)if(g.isTabSelected(a[b]))return!0;return g.tabSelected===a},g.getService=function(){return g.selection.service[g.tabSelected]},g.getServiceFilters=function(){var a=g.getService();if(a)return a.filter||(a.filter=[])};var h=function(){g.serviceHelper={all:void 0!==g.selection.service.all,get:void 0!==g.selection.service.get,post:void 0!==g.selection.service.post,put:void 0!==g.selection.service.put,delete:void 0!==g.selection.service.delete}}.bind(g);g.select=function(a){g.active=a,g.selection=angular.copy(a),h(),b.go("entities.edit",{entity:a.name})},g.getSelectionTables=function(){var a={};return a[g.selection.table]=angular.copy(g.tables[g.selection.table]),angular.forEach(g.selection.fk,function(b,c){var d=b.relation.split("@")[1],e=angular.copy(g.tables[d]);b.alias&&(e.name=b.alias),a[e.name]=e}.bind(g)),a},g.isAList=function(a){return a instanceof Array},g.toggleService=function(a){var b=!g.serviceHelper[a];if(b)g.selection.service[a]={};else{var c=function(b){delete g.selection.service[a],g.save()}.bind(g),d=function(b){g.serviceHelper[a]=!0}.bind(g),e=f.confirm("Please Confirm","Are you sure you want to remove the <strong>"+a+"</strong> service? me operation can´t be undone");e.result.then(c,d)}},g.hasService=function(a){return g.serviceHelper[a]},g.save=function(a){g.working=!0,a=a||g.selection,c.save(a).then(function(a){g.working=!1})},g.cancel=function(){g.select(g.active)},g.validatePath=function(){c.isPathValid(g.selection.path)||(g.general.$valid=!1)}}]),angular.module("LetRestEditor").controller("FKCtrl",["$scope","dialogs",function(a,b){this.selection=null;var c={comparator:"=",jointype:"INNER",source:a.Entities.selection.table},d=["_name","name","table","tablefield"];this.select=function(a,b){var d=angular.copy(b);d.name=d._name=a;var e=b.relation&&b.relation.split("@")||[];d.table=e[1],d.tablefield=e[0],d.field&&d.field.indexOf(".")!==-1&&(d.field=d.field.split(".")[1]),this.selection=angular.extend({},c,d)},this.isNameUnique=function(b){return this.selection._name===b||!a.Entities.selection.fk[b]}.bind(this),this.getSourceTables=function(){var b=[];return b.push(c.source),this.selection.table&&b.push(this.selection.table),angular.forEach(a.Entities.selection.fk,function(a,c){a.relation&&b.push(a.relation.split("@")[1])}),b},this.create=function(){this.select(null,{type:"url"})},this.save=function(){this.selection.relation=this.selection.tablefield+"@"+this.selection.table;var b=this.selection.name,e=this.selection._name;angular.forEach(d,function(a){delete this.selection[a]}.bind(this)),angular.forEach(c,function(a,b){this.selection[b]==c[b]&&delete this.selection[b]}.bind(this)),delete a.Entities.selection.fk[e],a.Entities.selection.fk[b]=this.selection,a.Entities.save(),this.cancel()},this.remove=function(c){var d=b.confirm("Please Confirm","Are you sure of removing the <strong>"+c+"</strong> FK?");d.result.then(function(b){delete a.Entities.selection.fk[c],a.Entities.save()},function(a){})},this.cancel=function(){this.selection=null}}]),angular.module("LetRestEditor").controller("FilterCtrl",["$scope","dialogs","ParserService",function(a,b,c){this.selection=null,this.selectionIndex=null;var d=a.Entities,e=d.selection.table,f={source:"path",comparator:"like"},g=["fields","values"];this.getFilters=d.getServiceFilters.bind(d),this.getAttrOrDefault=function(a,b){return a[b]||f[b]},this.select=function(a,b){this.tables=d.getSelectionTables();var g=angular.copy(a);g.values=a.value,g.values&&g.values instanceof Array==0&&(g.values=[g.values]),g.fields=c.parseTableRef(a.field,e),g.fields&&g.fields instanceof Array==0&&(g.fields=[g.fields]),g.type=a.type||"string",this.selection=angular.extend({},f,g),this.selectionIndex=b},this.removeFilter=function(a){var c=function(b){this.getFilters().splice(a,1),d.save()}.bind(this),e=b.confirm("Please Confirm","Are you sure you want to remove the <strong>"+this.getFilters()[a].key+"</strong> filter? This operation can´t be undone");e.result.then(c)},this.addFilter=function(a){this.select({key:a}),this.addField()},this.removeField=function(a){var c=function(b){this.selection.fields.splice(a,1),this.selection.values.splice(a,1),d.save()}.bind(this),e=b.confirm("Please Confirm","Are you sure you want to remove the <strong>"+this.selection.fields[a].key+"</strong> field? This operation can´t be undone");e.result.then(c)},this.addField=function(){this.selection.fields||(this.selection.fields=[]),this.selection.fields.push({table:"",field:""}),this.selection.values||(this.selection.values=[]),this.selection.values.push("")},this.save=function(){if(1==this.selection.fields.length)this.selection.field=this.selection.fields[0].table+"."+this.selection.fields[0].field,this.selection.value=this.selection.values[0];else{this.selection.field=[],this.selection.value=[];for(var a=0;a<this.selection.fields.length;a++){var b=this.selection.fields[a],c=this.selection.values[a];this.selection.field.push(b.table+"."+b.field),this.selection.value.push(c)}}null!=this.selectionIndex?this.getFilters()[this.selectionIndex]=this.selection:this.getFilters().push(this.selection),angular.forEach(g,function(a){delete this.selection[a]},this),console.log(this.selection),this.cancel()},this.cancel=function(){this.selection=null,this.selectionIndex=null}}]),angular.module("LetRestEditor").controller("MappingCtrl",["$scope","dialogs",function(a,b){this.selection=null;var c=a.Entities,d=(c.tables,c.selection.table),e=c.selection.mapping,f={},g=["table","tablefield","index"];this.isNameUnique=function(a){return!e.some(function(b,c){return c!=this.selection.index&&b.attribute===a}.bind(this))}.bind(this),this.select=function(a,b){if(this.tables=c.getSelectionTables(),this.selection=angular.copy(b),this.selection.index=a>=0?a:c.selection.mapping.length,this.selection.field){var e=this.selection.field.split("@");1==e.length&&e.push(d),this.selection.table=e[1],this.selection.tablefield=e[0]}this.selection.type=this.selection.type||"string"},this.save=function(){this.selection.field=this.selection.tablefield+"@"+this.selection.table;var a=this.selection.index;angular.forEach(g,function(a){delete this.selection[a]},this),angular.forEach(f,function(a,b){this.selection[b]==f[b]&&delete this.selection[b]},this),e[a]=this.selection,c.save(),this.cancel()},this.create=function(){this.select(-1,{})},this.remove=function(a){var d=b.confirm("Please Confirm","Are you sure of removing the Mapping?");d.result.then(function(b){e.splice(a,1),c.save()})},this.cancel=function(){this.selection=null}}]),angular.module("LetRestEditor").controller("MeasureCtrl",["$scope","dialogs","ParserService",function(a,b,c){this.selection=null;var d=a.Entities,e=(d.selection.table,["key","keyOriginal"]);this.measures=d.selection.service.all.group.measures,this.useGenerator=!1,this.isKeyValid=function(a){return void 0===this.measures[a]},this.select=function(a,b){this.tables=d.getSelectionTables(),this.selection=angular.copy(a),this.selection.key=b,this.selection.keyOriginal=this.selection.key,this.selection.attribute=this.selection.attribute||this.selection.key},this.remove=function(a){var c=function(b){delete this.measures[a],d.save()}.bind(this),e=b.confirm("Please Confirm","Are you sure you want to remove the <strong>"+a+"</strong> measure? This operation can´t be undone");e.result.then(c)},this.add=function(a){this.select({attribute:a},a)},this.parseGenerator=function(a){var b=[a.distinct?"DISTINCT ":"",a.operation,"(",a.table,".",a.field,")"];return b.join("")},this.save=function(){this.selection.field=this.selection.field.table+"."+this.selection.field.field,this.measures[this.selection.key]=this.selection,angular.forEach(this.selection,function(a,b){e.indexOf(b)>=0&&delete this.selection[b]},this),console.log(this.selection),d.save(),this.cancel()},this.cancel=function(){this.selection=null,this.useGenerator=!1}}]),angular.module("LetRestEditor").controller("OrderCtrl",["$scope","dialogs","ParserService",function(a,b,c){this.selection=null;var d=a.Entities,e=d.selection.table;d.selection.service.all.order||(d.selection.service.all.order={}),this.orders=d.selection.service.all.order;var f={},g=["fields","values"];this.isFieldUnique=function(a,b){if(this.selection.fields.length<=1)return!0}.bind(this),this.select=function(a,b){this.tables=d.getSelectionTables();var f={};f.original=a,f.key=a,b&&(f.fields=c.parseOrder(b,e),f.fields instanceof Array==0&&(f.fields=[f.fields])),this.selection=f},this.removeOrder=function(a){var c=function(b){delete this.orders[a],d.save()}.bind(this),e=b.confirm("Please Confirm","Are you sure you want to remove the <strong>"+a+"</strong> order? This operation can´t be undone");e.result.then(c)},this.addOrder=function(a){this.select(a),this.addField()},this.removeField=function(a){var c=function(b){this.selection.fields.splice(a,1),d.save()}.bind(this),e=b.confirm("Please Confirm","Are you sure you want to remove the <strong>"+this.selection.fields[a].key+"</strong> field? This operation can´t be undone");e.result.then(c)},this.addField=function(){this.selection.fields||(this.selection.fields=[]),this.selection.fields.push({table:"",field:"",type:"ASC"})};var h={};this.getFields=function(a,b){return h[a]||(h[a]=c.parseOrder(b,e)),h[a]},this.save=function(){for(var a=[],b=0;b<this.selection.fields.length;b++){var c=this.selection.fields[b];a.push(c.table+"."+c.field+" "+c.type)}this.orders[this.selection.original]=null,this.orders[this.selection.key]=a.join(","),h[this.selection.key]=null,angular.forEach(g,function(a){delete this.selection[a]},this),angular.forEach(f,function(a,b){this.selection[b]==f[b]&&delete this.selection[b]},this),console.log(this.selection),d.save(),this.cancel()},this.cancel=function(){this.selection=null}}]),angular.module("LetRestEditor").controller("PrePostActionsCtrl",["$scope","ParserService","ActionService",function(a,b,c){var d=a.Entities,e=d.getService();console.log("PrePostActionsCtrl called"),this.filess=[{name:"dummy/file01.js",methods:["doSomething","doAnotherThing","doNothing"]},{name:"dummy/file02.js",methods:["doCrazy","doYourBest","doTheTask"]},{name:"fact/shortcuts.js",methods:["shortcuts"]},{name:"post/mapping.js",methods:["doMapping","insertMapping"]}],this.files=c.list,this.getMethods=function(a){for(var b=0;b<this.files.length;b++)if(this.files[b].name==a)return this.files[b].methods},this.pre=b.parseActions(e.pre),this.post=b.parseActions(e.post),this.save=function(){this.pre.file||(e.pre=""),this.pre.file&&this.pre.method&&(e.pre=this.pre.method+"@"+this.pre.file),this.post.file||(e.post=""),this.post.file&&this.post.method&&(e.post=this.post.method+"@"+this.post.file),d.save()}}]),angular.module("LetRestEditor").controller("ServiceCtrl",["$scope","$state","ServicesService","GeneralService","ActionService","dialogs",function(a,b,c,d,e,f){this.selection=null,this.serviceHelper=null,this.active=null,this.services=c.list,this.files=e.all,this.selectedPath=null,this.getService=function(){return this.selection.service[this.tabSelected]},this.getServiceFilters=function(){var a=this.getService();if(a)return a.filter||(a.filter=[])},this.select=function(a){this.active=a,this.selection=angular.copy(a),b.go("services.edit",{entity:a.name})},this.selectPath=function(a,b){this.selectedPathName=a,this.selectedPath=angular.copy(b),this.selectedPath.name=a},this.isAList=function(a){return a instanceof Array},this.toggleService=function(a){var b=!this.serviceHelper[a];if(b)this.selection.service[a]={};else{var c=function(b){delete this.selection.service[a],this.save()}.bind(this),d=function(b){this.serviceHelper[a]=!0}.bind(this),e=f.confirm("Please Confirm","Are you sure you want to remove the <strong>"+a+"</strong> service? This operation can´t be undone");e.result.then(c,d)}},this.hasService=function(a){return this.serviceHelper[a]},this.cleanSelection=function(){this.selectedPathName=null,this.selectedPath=null},this.save=function(a){a=a||this.selection,a.config[this.selectedPathName]=this.selectedPath,this.cleanSelection(),c.save(a)},this.cancel=function(){this.cleanSelection(),this.select(this.active)},this.removePath=function(a){delete this.selection.config[a],c.save(this.selection),this.cleanSelection()},this.getMethods=function(a){for(var b=0;b<this.files.length;b++)if(this.files[b].name==a)return this.files[b].methods}}]),function(a){a.module("LetRestEditor").factory("ServicesService",["K","$http","GeneralService",function(b,c,d){function e(){var b=[];a.forEach(f.all,function(a,c){b.push(a)}),a.copy(b,f.list)}var f={};return f.all={},f.list=[],f.sync=function(){return c.get(b.SERVICES_URL).then(function(b){a.copy(b.data,f.all),e()}).catch(function(a){console.log(a)})},f.save=function(a){console.log(a),c.post(b.SERVICES_URL,a).then(function(){d.addAlert("success","Succesfully saved the service"),f.sync()}).catch(function(a){d.addAlert("danger","Failed to save the service")})},f.isNameValid=function(a){return void 0===f.all[a]},f.isPathValid=function(a){for(var b in f.all)if(f.all[b].path===a)return!1;return!0},f.sync(),f}])}(window.angular),angular.module("LetRestEditor").filter("mappingAttribute",function(){return function(a){return a.replace("@",".")}}),angular.module("LetRestEditor").filter("renderFkField",function(){return function(a,b){var c="";return a.source!==b&&(c+=a.source+"."),c+a.field}}),angular.module("LetRestEditor").factory("DatabaseService",["K","$http",function(a,b){var c={};return c.all={},c.list=[],c.sync=function(){return b.get(a.TABLES_URL).then(function(a){var b=[];angular.copy(a.data,c.all),angular.forEach(a.data,function(a,c){b.push(a)}),angular.copy(b,c.list)}).catch(function(a){console.log(a)})},c.getTable=function(a){return c.all[a]},c.sync(),c}]),angular.module("LetRestEditor").factory("EntitiesService",["K","$http","GeneralService",function(a,b,c){function d(){var a=[];angular.forEach(e.all,function(b,c){a.push(b)}),angular.copy(a,e.list)}var e={};return e.all={},e.list=[],e.sync=function(){return console.log(a.ENTITIES_URL),b.get(a.ENTITIES_URL).then(function(a){angular.copy(a.data,e.all),d()}).catch(function(a){console.log(a)})},e.save=function(d){return b.post(a.ENTITIES_URL,d).then(function(){c.addAlert("success","Succesfully saved the entity"),e.sync()}).catch(function(a){c.addAlert("danger","Failed to save the entity")})},e.isNameValid=function(a){return void 0===e.all[a]},e.isPathValid=function(a){for(var b in e.all)if(e.all[b].path===a)return!1;return!0},e.sync(),e}]),angular.module("LetRestEditor").factory("ParserService",function(){var a={};return a.populateKeys=function(a,b){var c=b||"key";return angular.forEach(a,function(a,b){a[c]=b},this),a},a.parseTableRef=function(b,c){if(b){if(b instanceof Array){var d=[];return b.forEach(function(b){d.push(a.parseTableRef(b,c))}),d}var e=b.split(".");return 1===e.length?{table:c,field:e[0].trim(),raw:b}:{table:e[0].trim(),field:e[1].trim(),raw:b}}},a.parseOrder=function(b,c){var d=b.split(",");if(d.length>1){var e=[];return d.forEach(function(b){e.push(a.parseOrder(b,c))}),e}var f=a.parseTableRef(b,c),g=f.field.split(" ");return 1===g.length?f.type="ASC":(f.field=g[0],f.type=g[1]),f},a.parseActions=function(a){return a?{file:a.split("@")[1],method:a.split("@")[0]}:{}},a.getPk=function(a){var b;return angular.forEach(a,function(a,c){b||a.pk&&(b=a)}),b&&b.name},a.getFks=function(a){var b={};return angular.forEach(a,function(a,c){a.fk&&(b[a.name]={relation:a.name+"@"+a.fktable,field:a.name,type:"object",value:a.fktable+"."+a.name,_selected:!1,_raw:a})},this),b},a.initMapping=function(a,b,c){var d=[];return angular.forEach(a,function(a,e){d.push({field:a.name+"@"+b,attribute:(c?b+"@":"")+a.name,external:a.pk||a.fk||c,_selected:!1,_table:b})},this),d},a.parseTableToEntity=function(b){var c={name:b.name,path:"/"+b.name,table:b.name,weight:0,pk:a.getPk(b.fields),fk:a.getFks(b.fields),mapping:a.initMapping(b.fields,b.name),service:{},_raw:b};return c},a.getCleanEntity=function(b){var c=angular.copy(b);return angular.forEach(c.service,function(a,b){a?c.service[b]={}:delete c.service[b]},this),a.getCleanObject(c)},a.getCleanObject=function(b){return angular.forEach(b,function(c,d){var e="string"==typeof d&&0===d.indexOf("_"),f=b[d]instanceof Object&&b[d]._selected===!1,g=e||f;g&&delete b[d],b[d]instanceof Object&&(b[d]=a.getCleanObject(b[d]))},this),b instanceof Array&&(b=b.filter(function(a){return null!==a})),b},a.createSchema=function(a){return{definition:{id:a.path,properties:{}},dependencies:[]}},a}),angular.module("LetRestEditor").factory("ActionService",["K","$http",function(a,b){var c={};return c.list=[],c.all=[],c.syncPrePost=function(){return b.get(a.ACTIONS_URL+"prepost").then(function(a){angular.copy(a.data,c.list)}).catch(function(a){console.log(a)})},c.syncServices=function(){return b.get(a.ACTIONS_URL+"services").then(function(a){angular.copy(a.data,c.all)}).catch(function(a){console.log(a)})},c.sync=function(){c.syncPrePost(),c.syncServices()},c.sync(),c}]),angular.module("LetRestEditor").controller("WizardCtrl",["$scope","EntitiesService",function(a,b){var c=this;c.defaultActions=[{text:"Previous",action:"previous",state:"",where:"left"},{text:"Next",action:"next",state:"",where:"right"},{text:"Done",action:"finish",state:"",where:"right"}];var d=a.EntityWizard;c.steps=d.steps,c.step=c.steps[0],c.stepIndex=0,c.goNext=function(){c.stepIndex!==c.steps.length-1&&(c.stepIndex++,c.step=c.steps[c.stepIndex])},c.goPrevious=function(){0!==c.stepIndex&&(c.stepIndex--,c.step=c.steps[c.stepIndex])},c.doFinish=function(){d.save(),c.stepIndex=0,c.step=c.steps[0]},c.doCancel=function(){},c.isEnabled=function(a){switch(a.action){case"next":return c.stepIndex<1||d.newEntity;case"finish":return d.isEntityValid();default:return!0}},c.isVisible=function(a){switch(a.action){case"previous":return c.stepIndex>0;case"next":return c.stepIndex<c.steps.length-1;case"finish":return c.stepIndex===c.steps.length-1;default:return!0}},c.executeAction=function(a){switch(a.action){case"next":c.goNext();break;case"previous":c.goPrevious();break;case"finish":c.doFinish();break;case"cancel":c.doCancel()}}}]),angular.module("LetRestEditor").controller("EntityWizardCtrl",["$scope","DatabaseService","EntitiesService","ParserService",function(a,b,c,d){function e(a,b,c){if("string"==typeof c)var c=c.split(".");if(c.length>1){var d=c.shift();null!=a[d]&&"object"==typeof a[d]||(a[d]={}),e(a[d],b,c)}else a[c[0]]=b}this.steps=[{name:"start",title:"Start",url:"views/wizard/steps/welcome.html",actions:this.defaultActions},{name:"table",title:"Table",url:"views/wizard/steps/table.html",actions:this.defaultActions},{name:"relations",title:"Relations",url:"views/wizard/steps/relations.html",actions:this.defaultActions},{name:"mappings",title:"Mappings",url:"views/wizard/steps/mappings.html",actions:this.defaultActions},{name:"services",title:"Services",url:"views/wizard/steps/services.html",actions:this.defaultActions},{name:"name",title:"Name it",url:"views/wizard/steps/name.html",actions:this.defaultActions}],this.tables=b.all,this.isNameValid=function(a){return c.isNameValid(a)},this.isPathValid=function(a){return 0===a.indexOf("/")&&c.isPathValid(a)},this.isEntityValid=function(){return this.newEntity&&this.isNameValid(this.newEntity.name)},this.getEntityFromTable=function(a){return"string"==typeof a&&(a=b.getTable(a)),d.parseTableToEntity(a)},this.select=function(a){this.newEntity=this.getEntityFromTable(a),this.groupMappingByTable()},this.getCleanEntity=function(){return this.newEntity&&d.getCleanEntity(this.newEntity)},this.toArray=function(a){return Object.keys(a)},this.includeAllServices=function(){angular.forEach(["all","get","post","put","delete"],function(a){this.newEntity.service[a]=!0},this)},this.getMapper=function(){var a={};return angular.forEach(this.newEntity.mapping,function(b,c){b._selected&&e(a,"foo",b.attribute)},this),a},this.getRelatedTables=function(){var a=[];return angular.forEach(this.newEntity.fk,function(c,e){c._selected&&a.push({name:c._raw.fktable,fields:d.parseTableToEntity(b.getTable(c._raw.fktable)).mapping})},this),a},this.updateFk=function(a){console.log(a._parentTable);var c=a._raw.name;if(a._selected){var e=b.getTable(a._raw.fktable),f=d.getFks(e.fields,a._parentTable);this.newEntity.fk[c]=a,a._parentTable&&(a.source=a._parentTable),angular.forEach(f,function(b,d){b._parent=c,b._parentTable=a._raw.fktable,this.newEntity.fk[d]=b},this)}else a._parent&&this.newEntity.fk[c]?delete this.newEntity.fk[a._raw.name]:angular.forEach(this.newEntity.fk,function(a,b){a._parent===c&&(a._selected=!1,this.updateMapping(a),delete this.newEntity.fk[b])},this);this.updateMapping(a)},this.updateMapping=function(a){if(a._selected){var c=b.getTable(a._raw.fktable),e=d.initMapping(c.fields,c.name,!0);this.newEntity.mapping.push.apply(this.newEntity.mapping,e)}else this.newEntity.mapping=this.newEntity.mapping.filter(function(b){return b._table!==a._raw.fktable});this.groupMappingByTable()},this.groupMappingByTable=function(){var a=this.newEntity._mappingByTable={};angular.forEach(this.newEntity.mapping,function(b,c){var d=b._table||this.newEntity.table;a[d]=a[d]||[],a[d].push(b)},this)},this.toggleMappingsHelper=!1,this.initToggleMappingsHelper=function(){var a=!0;angular.forEach(this.newEntity.mapping,function(b,c){a&&(a=b._selected)},this),this.toggleMappingsHelper=a},this.toggleMappings=function(){angular.forEach(this.newEntity.mapping,function(a,b){a._selected=this.toggleMappingsHelper},this)},this.tableHasRelations=function(){return Object.keys(this.newEntity.fk).length>0},this.initNaming=function(){this.updatePath()},this.updatePath=function(){this.chooseName.inputPath.$pristine&&(this.newEntity.path="/"+(this.newEntity.name||""))},this.getSchema=function(){return this.newEntity&&d.createSchema(this.newEntity)},this.save=function(){var a=this.getCleanEntity();a.schema=this.getSchema(),c.save(a),this.newEntity=null}}]),angular.module("LetRestEditor").controller("ConfigCtrl",["$scope","$state","dialogs","ConfigService","DatabaseService",function(a,b,c,d,e){var f=this;f.general=d.general,f.generalDBselect=null,f.security=d.security,f.databases=d.database,f.dbConfigurationSelected=null,f.tables=e.list,f.working=!1,f.select=function(a){switch(f.selection=a,a){case"database":d.syncDatabase();break;case"general":d.syncGeneral();break;case"security":d.syncSecurity()}},f.addGeneralDB=function(){f.general.databases.push(f.generalDBselect),f.generalDBselect=null},f.removeGeneralDB=function(a){var b=c.confirm("Please Confirm","Are you sure of removing the DB?");b.result.then(function(b){f.general.databases.splice(a,1)})},f.createGeneralDB=function(){f.generalDBselect={}},f.selectGeneralDB=function(a,b){f.generalDBselect=b},f.addDBConfiguration=function(){f.databases[f.dbConfigurationSelected.name]=f.dbConfigurationSelected,delete f.dbConfigurationSelected.name,f.dbConfigurationSelected=null},f.removeDBConfiguration=function(a,b){var d=c.confirm("Please Confirm","Are you sure of removing the DB?");d.result.then(function(a){delete f.databases[b]})},f.createDBConfiguration=function(){f.dbConfigurationSelected={}},f.selectDBConfiguration=function(a,b,c){c.name=b,f.dbConfigurationSelected=c},f.saveDatabase=function(){f.working=!0,d.saveDatabase(f.databases).then(function(a){f.working=!1})},f.saveGeneral=function(){f.working=!0,d.saveGeneral(f.general).then(function(a){f.working=!1})},f.saveSecurity=function(){f.working=!0,d.saveSecurity(f.security).then(function(a){f.working=!1})},d.syncDatabase(),d.syncGeneral(),d.syncSecurity(),e.sync()}]),angular.module("LetRestEditor").factory("ConfigService",["K","$http","GeneralService",function(a,b,c){var d={};return d.general={},d.database={},d.security={},d.syncDatabase=function(){return b.get(a.CONFIG_UW_URL).then(function(a){console.log(a),angular.copy(a.data,d.database)}).catch(function(a){console.log(a)})},d.saveDatabase=function(e){return b.post(a.CONFIG_UW_URL,e).then(function(){c.addAlert("success","Succesfully saved the database configuration."),d.syncDatabase()}).catch(function(a){c.addAlert("danger","Failed to save the database configuration.")})},d.syncGeneral=function(){return b.get(a.CONFIG_GENERAL_URL).then(function(a){console.log(a),angular.copy(a.data,d.general)}).catch(function(a){console.log(a)})},d.saveGeneral=function(e){return b.post(a.CONFIG_GENERAL_URL,e).then(function(){c.addAlert("success","Succesfully saved the general configuration."),d.syncGeneral()}).catch(function(a){c.addAlert("danger","Failed to save the general configuration")})},d.syncSecurity=function(){return b.get(a.CONFIG_SECURITY_URL).then(function(a){console.log(a),angular.copy(a.data,d.security)}).catch(function(a){console.log(a)})},d.saveSecurity=function(e){return b.post(a.CONFIG_SECURITY_URL,e).then(function(){c.addAlert("success","Succesfully saved the security configuration."),d.syncSecurity()}).catch(function(a){c.addAlert("danger","Failed to save the security configuration.")})},d}]);