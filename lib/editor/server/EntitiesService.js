/*! letrest - v0.0.32 - 2015-08-06 */var MODULE="Entities Service | ",LOG=require("uw").log,PATH=require("path"),ENTITY_PATH=PATH.dirname(process.mainModule.filename)+"/../config/letrest/entities/",SCHEMA_PATH=PATH.dirname(process.mainModule.filename)+"/../config/letrest/schemas/",SECURITY_PATH=PATH.dirname(process.mainModule.filename)+"/../config/letrest/security/config.json",CONFIG_PATH=PATH.dirname(process.mainModule.filename)+"/../config/letrest/config.json",CRUDS_PATH=PATH.dirname(process.mainModule.filename)+"/../config/letrest/crud/",getEntities=function(){var a={};LOG.info(MODULE,"Reading entities.");for(var b=require("fs").readdirSync(ENTITY_PATH),c=0;c<b.length;c++)if(".json"==b[c].substr(b[c].length-5)){LOG.info(MODULE,"Processing entity file",b[c]);var d=require(ENTITY_PATH+b[c]);d.name!=b[c].replace(".json","")&&LOG.warn(MODULE,"Entity Definition name not match file name =>",b[c]),a[d.name]=d}else LOG.warn(MODULE,"Skipping file "+b[c]);return a},startsWithUntil=function(a,b,c){return 0==c.lastIndexOf(a,0)&&c.lastIndexOf(b)==a.length},saveEntity=function(a){return a.schema&&(saveWithBackup(a.name,a.schema,SCHEMA_PATH,"SAVING SCHEMA: "),a.schema=null),saveWithBackup(a.name,a,ENTITY_PATH,"SAVING ENTITY: ")},saveWithBackup=function(a,b,c,d){if(a){var e=a;LOG.info(MODULE,d+e);for(var f=require("fs"),g=f.readdirSync(c),h=0;h<g.length;h++){var i=g[h];if(startsWithUntil(e,".",i)){for(var j=1;startsWithUntil(e,"_",g[h+j]);)j++;var k=i.substr(0,i.lastIndexOf("."))+"_"+j+".bkup";f.rename(c+i,c+k);break}}return f.writeFileSync(c+e+".json",JSON.stringify(b,null,"	"))}return-1};module.exports.allservice=function(a,b){b.send(getEntities())},module.exports.saveservice=function(a,b){b.send(saveEntity(a.body))};