/*! letrest - v0.0.28 - 2015-05-19 */var SCHEMAS={},ENTITIES={},SECURITY={},CONFIG={},CRUDS={},WADLS={},MODULE="CONFIG	",PATH=require("path"),ENTITY_PATH=PATH.dirname(process.mainModule.filename)+"/../config/letrest/entities/",SCHEMA_PATH=PATH.dirname(process.mainModule.filename)+"/../config/letrest/schemas/",SECURITY_PATH=PATH.dirname(process.mainModule.filename)+"/../config/letrest/security/config.json",CONFIG_PATH=PATH.dirname(process.mainModule.filename)+"/../config/letrest/config.json",CRUDS_PATH=PATH.dirname(process.mainModule.filename)+"/../config/letrest/crud/",MERGE=require("merge"),LOG=require("uw").log,DOTTY=require("dotty"),copy=function(a){return JSON.parse(JSON.stringify(a))},parseConstants=function(a){for(var b in a.constants){for(var c=0;c<a.actions.length;c++)a.actions[c].label&&(a.actions[c].label=a.actions[c].label.replace(new RegExp("#"+b+"#","g"),a.constants[b])),void 0==a.actions.position&&(a.actions.position=-1),void 0==a.actions.weight&&(a.actions.weight=-1);if(a.fields)for(var c=0;c<a.fields.length;c++)a.fields[c].label&&(a.fields[c].label=a.fields[c].label.replace(new RegExp("#"+b+"#","g"),a.constants[b])),void 0==a.fields[c].position&&(a.fields[c].position=0),void 0==a.fields[c].weight&&(a.fields[c].weight=-1),void 0==a.fields[c].readonly&&(a.fields[c].readonly=!1)}return a},merge=function(a,b){var c=copy(a),d=copy(b),e=MERGE.recursive(!0,d,c);return e.fields=[].concat(d.fields||[],c.fields||[]),e.filters=[].concat(d.filters||[],c.filters||[]),e.actions=[].concat(d.actions||[],c.actions||[]),e},processHierarchy=function(a){if(CRUDS[a.parent])return merge(a,CRUDS[a.parent]);var b=a.parent+".crud.json",c=retrieveCRUD(b);return CRUDS[a.parent]=c,merge(a,c)},retrieveCRUD=function(a){var b=require(CRUDS_PATH+a);return b.parent&&(b=processHierarchy(b)),b},fillCRUDs=function(){LOG.info(MODULE,"Reading cruds.");for(var a=require("fs").readdirSync(CRUDS_PATH),b=0;b<a.length;b++){LOG.info(MODULE,"Processing crud file",a[b]);var c=retrieveCRUD(a[b]);CRUDS[a[b].replace(".crud.json","")]=c}for(var d in CRUDS)parseConstants(CRUDS[d])},fillEntities=function(){LOG.info(MODULE,"Reading entities.");for(var a=require("fs").readdirSync(ENTITY_PATH),b=0;b<a.length;b++){LOG.info(MODULE,"Processing entity file",a[b]);var c=require(ENTITY_PATH+a[b]);c.name!=a[b].replace(".json","")&&LOG.warn(MODULE,"Entity Definition name not match file name =>",a[b]),ENTITIES[c.name]=c}},fillSchemas=function(){LOG.info(MODULE,"Reading schemas.");for(var a=require("fs").readdirSync(SCHEMA_PATH),b=0;b<a.length;b++){LOG.info(MODULE,"Processing schema file",a[b]);var c=require(SCHEMA_PATH+a[b]);c.definition.id!="/"+a[b].replace(".json","")&&LOG.warn(MODULE,"Schema Definition name not match file name =>",a[b]),SCHEMAS[a[b].replace(".json","")]=c}},fillSecurity=function(){LOG.info(MODULE,"Reading scurity."),SECURITY=require(SECURITY_PATH)},fillConfig=function(){CONFIG=require(CONFIG_PATH)},parseNew=function(a){for(var b={},c=0;c<a.mapping.length;c++)if("undefined"!=typeof a.mapping[c]["default"]){var d=a.mapping[c].attribute.replace("@",".");DOTTY.put(b,d,a.mapping[c]["default"])}return b},findPKMapped=function(a){if(a.mapping)for(var b=0;b<a.mapping.length;b++){var c=a.mapping[b];if(c.field===a.pk)return c.attribute}return a.pk},createWADLs=function(){for(var a in ENTITIES){var b=ENTITIES[a],c=findPKMapped(b),d={};if(d.type=b.name,d.host="",d.url="api"+b.path+"/:"+c+"/",d.id=c,d.map={},d.map[d.id]="@"+d.id,d.actions={},b.service.all){d.actions.ALL={params:["FROM","ROWS","?GROUP","?ORDER","?AGGREGATE"]};for(var a in b.service.all.filter){var e=b.service.all.filter[a];(e.source="url")&&d.actions.ALL.params.push("?"+e.key)}if(b.service.all.group){d.actions.ALL.group={dimensions:{},measures:{}};for(var a in b.service.all.group.dimensions)d.actions.ALL.group.dimensions[a]={label:a};for(var a in b.service.all.group.measures)d.actions.ALL.group.measures[a]={label:a}}}b.service.get&&(d.actions.GET={params:[c]}),b.service.put&&(d.actions.PUT={params:[c]}),b.service.post&&(d.actions.POST={params:[]}),b.service["delete"]&&(d.actions.DELETE={params:[c]}),b.defaultnew&&(d["new"]=parseNew(b)),WADLS[b.name]=d}};exports.init=function(){LOG.info(MODULE,"Initializing Let-Rest config."),fillConfig(),fillEntities(),fillSchemas(),fillSecurity(),fillCRUDs(),createWADLs()},exports.getEntities=function(){return ENTITIES},exports.getSchemas=function(){return SCHEMAS},exports.getSecurity=function(){return SECURITY},exports.getConfig=function(){return CONFIG},exports.getCRUDs=function(){return CRUDS},exports.getWADLs=function(){return WADLS};